{% extends 'base.html' %}
{% load static %}

{% block title %}{{ job.title }} | MyApply{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">{{ job.title }}</h1>
    <div class="page-header-actions">
        <a href="{% url 'job_edit' job.id %}" class="btn">Edit Job</a>
        <a href="{% url 'job_delete' job.id %}" class="btn btn-danger">Delete</a>
    </div>
</div>

<!-- Job Details Card -->
<div class="job-detail-card">
    <div class="job-detail-header">
        <div>
            <h2 class="job-detail-title">{{ job.company }}</h2>
            {% if job.location_text %}
            <div class="job-detail-meta">
                <svg class="icon-location" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                    <circle cx="12" cy="10" r="3"></circle>
                </svg>
                {{ job.location_text }}
            </div>
            {% endif %}
        </div>
        <div class="job-detail-date">
            <svg class="icon-calendar" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
            Added {{ job.created_at|date:"M d, Y" }}
        </div>
    </div>

    {% if job.source_url %}
    <div class="job-detail-url">
        <svg class="icon-link" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
            <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
        </svg>
        <a href="{{ job.source_url }}" target="_blank" rel="noopener">{{ job.source_url }}</a>
    </div>
    {% endif %}

    {% if job.raw_description %}
    <div class="job-detail-description">
        <h3 class="section-heading">Job Description</h3>
        <div class="description-content">{{ job.raw_description|linebreaks }}</div>
    </div>
    {% endif %}
</div>

<!-- Tailoring Relationship Dashboard -->
<div class="relationship-dashboard">
    <div class="dashboard-header">
        <h2 class="dashboard-title">
            <svg class="icon-layers" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polygon points="12 2 2 7 12 12 22 7 12 2"></polygon>
                <polyline points="2 17 12 22 22 17"></polyline>
                <polyline points="2 12 12 17 22 12"></polyline>
            </svg>
            Tailoring Sessions
        </h2>
        <a href="{% url 'tailoring_create' %}?job_id={{ job.id }}" class="btn btn-primary">
            <svg class="icon-plus" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            Create New Session
        </a>
    </div>

    {% if tailoring_stats.total > 0 %}
    <!-- Stats Overview -->
    <div class="dashboard-stats">
        <div class="dash-stat dash-stat--completed">
            <div class="dash-stat__icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
            </div>
            <div class="dash-stat__content">
                <div class="dash-stat__value">{{ tailoring_stats.completed }}</div>
                <div class="dash-stat__label">Completed</div>
            </div>
        </div>
        <div class="dash-stat dash-stat--tokens">
            <div class="dash-stat__icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <path d="M12 6v6l4 2"></path>
                </svg>
            </div>
            <div class="dash-stat__content">
                <div class="dash-stat__value">{{ tailoring_stats.total_tokens|floatformat:0 }}</div>
                <div class="dash-stat__label">Total Tokens</div>
            </div>
        </div>
        <div class="dash-stat dash-stat--success">
            <div class="dash-stat__icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                    <polyline points="22 4 12 14.01 9 11.01"></polyline>
                </svg>
            </div>
            <div class="dash-stat__content">
                <div class="dash-stat__value">{{ tailoring_stats.success_rate }}%</div>
                <div class="dash-stat__label">Success Rate</div>
            </div>
        </div>
    </div>

    <!-- Timeline Visualization -->
    <div class="session-timeline">
        <h3 class="timeline-heading">Session History</h3>
        <div class="timeline-container">
            {% for session in job.tailoring_sessions.all %}
            <div class="timeline-item timeline-item--{{ session.status|lower }}">
                <div class="timeline-marker"></div>
                <div class="timeline-content">
                    <div class="timeline-header">
                        <div class="timeline-status">
                            <svg class="timeline-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                {% if session.status == 'COMPLETED' %}
                                <polyline points="20 6 9 17 4 12"></polyline>
                                {% elif session.status == 'PROCESSING' %}
                                <circle cx="12" cy="12" r="10"></circle>
                                <polyline points="12 6 12 12 16 14"></polyline>
                                {% elif session.status == 'FAILED' %}
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="15" y1="9" x2="9" y2="15"></line>
                                <line x1="9" y1="9" x2="15" y2="15"></line>
                                {% else %}
                                <circle cx="12" cy="12" r="10"></circle>
                                {% endif %}
                            </svg>
                            <span class="timeline-status-text">{{ session.get_status_display }}</span>
                        </div>
                        <div class="timeline-date">{{ session.created_at|date:"M d, Y - g:i A" }}</div>
                    </div>
                    {% if session.status == 'COMPLETED' %}
                    <div class="timeline-details">
                        {% if session.token_usage.total_tokens %}
                        <span class="timeline-meta">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <polygon points="10 8 16 12 10 16 10 8"></polygon>
                            </svg>
                            {{ session.token_usage.total_tokens|floatformat:0 }} tokens
                        </span>
                        {% endif %}
                        {% if session.generated_bullets %}
                        <span class="timeline-meta">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="8" y1="6" x2="21" y2="6"></line>
                                <line x1="8" y1="12" x2="21" y2="12"></line>
                                <line x1="8" y1="18" x2="21" y2="18"></line>
                                <line x1="3" y1="6" x2="3.01" y2="6"></line>
                                <line x1="3" y1="12" x2="3.01" y2="12"></line>
                                <line x1="3" y1="18" x2="3.01" y2="18"></line>
                            </svg>
                            {{ session.generated_bullets|length }} bullets
                        </span>
                        {% endif %}
                    </div>
                    {% endif %}
                    <div class="timeline-actions">
                        <a href="{% url 'tailoring_detail' session.id %}" class="timeline-btn">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                <circle cx="12" cy="12" r="3"></circle>
                            </svg>
                            View Session
                        </a>
                        {% if session.status == 'COMPLETED' %}
                        <a href="{% url 'tailoring_detail' session.id %}#download" class="timeline-btn timeline-btn--secondary">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="7 10 12 15 17 10"></polyline>
                                <line x1="12" y1="15" x2="12" y2="3"></line>
                            </svg>
                            Download
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% else %}
    <!-- Empty State -->
    <div class="dashboard-empty">
        <svg class="dashboard-empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"></path>
        </svg>
        <h3 class="dashboard-empty-title">No Tailoring Sessions Yet</h3>
        <p class="dashboard-empty-text">Create your first tailoring session to optimize your resume for this job opportunity.</p>
        <a href="{% url 'tailoring_create' %}?job_id={{ job.id }}" class="btn btn-primary">
            <svg class="icon-plus" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            Create First Session
        </a>
    </div>
    {% endif %}
</div>
{% endblock %}
